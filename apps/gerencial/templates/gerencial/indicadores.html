{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="container mx-auto">
  <!-- Header -->
  <div class="mb-4">
    <h1 class="text-3xl font-bold text-gray-900 mb-2">
      Dashboard de Indicadores
    </h1>
    <p class="text-gray-600">Percentual de conclus√£o de tarefas por usu√°rio</p>
  </div>

  <!-- Filtros -->
  <div class="bg-white rounded-lg shadow-md p-4 mb-4">
    <h2 class="text-xl font-semibold text-gray-800 mb-4">Filtros</h2>
    <form id="filtros-form" method="post"class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
      {% csrf_token %}
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Data In√≠cio</label>
        <input type="date" name="data_inicio" value="{{ filtros.data_inicio }}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Data Fim</label>
        <input type="date" name="data_fim" value="{{ filtros.data_fim }}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>

      <div class="relative w-full">
        <!-- Bot√£o do select -->
        <label class="block text-sm font-medium text-gray-700 mb-2">Departamento</label>

        <button type="button" id="departamentoBtn" class="w-full bg-white border border-gray-300 rounded-md px-3 py-2 text-left focus:outline-none focus:ring-2 focus:ring-purple-500 flex justify-between items-center">
          <span id="departamentoText">Todos os departamentos</span>
          <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </button>

        <!-- Lista de checkboxes -->
        <div id="departamentoList" class="absolute z-10 mt-1 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto hidden">
          {% for dep in lista_departamentos %}
            <label class="flex items-center gap-2 p-2 hover:bg-gray-100 cursor-pointer">
              <input type="checkbox" name="departamento" value="{{ dep.id }}"
      class="h-4 w-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500"
      {% if dep.id|stringformat:"s" in filtros.departamentos %}checked{% endif %} />
              {{ dep.nome }}
            </label>
          {% endfor %}
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Empresa</label>
        <select name="empresa" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="">Selecione uma empresa</option>
          {% for empresa in lista_empresas %}
            <option value="{{ empresa.nome }}" {% if filtros.empresa == empresa.nome %}selected{% endif %}>
              {{ empresa.nome }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="lg:col-span-5 flex gap-3 mt-4">
        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md font-medium transition duration-200">
          Aplicar Filtros
        </button>
        <button onclick="location.href='{{ indicadores }}'" type="reset" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-md font-medium transition duration-200">
          Limpar
        </button>
      </div>
    </form>
  </div>

  <!-- Cards de Resumo -->
  <div id="resumo-cards" class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-4">
    <div class="bg-white rounded-lg shadow-md p-6">
      <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wider">Total de Usu√°rios</h3>
      <p id="total-usuarios" class="text-3xl font-bold text-blue-600 mt-2">0</p>
    </div>
    <div class="bg-white rounded-lg shadow-md p-6">
      <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wider">Total de Tarefas</h3>
      <p id="total-tarefas" class="text-3xl font-bold text-green-600 mt-2">0</p>
    </div>
    <div class="bg-white rounded-lg shadow-md p-6">
      <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wider">Tarefas Conclu√≠das</h3>
      <p id="total-concluidas" class="text-3xl font-bold text-purple-600 mt-2">0</p>
    </div>
    <div class="bg-white rounded-lg shadow-md p-6">
      <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wider">Percentual M√©dio</h3>
      <p id="percentual-medio" class="text-3xl font-bold text-orange-600 mt-2">0%</p>
    </div>
  </div>

  <!-- Gr√°ficos -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-4">
    <div class="bg-white rounded-lg shadow-md p-6">
      <h3 class="text-xl font-semibold text-gray-800 mb-4">üèÜ Top 10 Melhores - Maior Percentual</h3>
      <div id="chart-barras-top" style="height: 400px"></div>
    </div>
    <div class="bg-white rounded-lg shadow-md p-6">
      <h3 class="text-xl font-semibold text-gray-800 mb-4">‚ö†Ô∏è Top 10 com Menor Percentual</h3>
      <div id="chart-barras-bottom" style="height: 400px"></div>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-4">
    <div class="bg-white rounded-lg shadow-md p-6">
      <h3 class="text-xl font-semibold text-gray-800 mb-4">Distribui√ß√£o de Performance</h3>
      <div id="chart-pizza" style="height: 400px"></div>
    </div>
    <div class="bg-white rounded-lg shadow-md p-6">
      <h3 class="text-xl font-semibold text-gray-800 mb-4">Comparativo: Melhores vs Piores</h3>
      <div id="chart-comparativo" style="height: 400px"></div>
    </div>
  </div>

  <div class="bg-white rounded-lg shadow-md p-6 mb-4">
    <h3 class="text-xl font-semibold text-gray-800 mb-4">Rela√ß√£o: Total de Tarefas vs Percentual de Conclus√£o</h3>
    <div id="chart-dispersao" style="height: 500px"></div>
  </div>

  <!-- Tabela Detalhada -->
  <div class="bg-white rounded-lg shadow-md p-6">
    <h3 class="text-xl font-semibold text-gray-800 mb-4">Detalhamento por Usu√°rio</h3>
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable(0)">Nome do Usu√°rio ‚Üï</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable(1)">Total de Tarefas ‚Üï</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable(2)">Tarefas Conclu√≠das ‚Üï</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable(3)">Percentual ‚Üï</th>
          </tr>
        </thead>
        <tbody id="tabela-body" class="bg-white divide-y divide-gray-200">
          {% for item in dados_percentual %}
            <tr class="hover:bg-gray-50">
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                {% if item.url_foto %}
                  <img src="{{ item.url_foto }}" alt="{{ item.nome }}" class="inline-block h-8 w-8 rounded-full" />
                {% else %}
                  <svg class="inline-block h-8 w-8 rounded-full bg-gray-200 text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                  </svg>
                {% endif %}
                {{ item.nome }}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ item.total_tarefas }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ item.tarefas_concluidas }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium {% if item.percentual >= 80 %}text-green-600{% elif item.percentual >= 60 %}text-yellow-600{% else %}text-red-600{% endif %}">{{ item.percentual }}%</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
<script>
  const btn = document.getElementById('departamentoBtn')
  const list = document.getElementById('departamentoList')
  const text = document.getElementById('departamentoText')
  
  btn.addEventListener('click', () => {
    list.classList.toggle('hidden')
  })
  
  // Atualiza o texto do bot√£o com os selecionados
  const checkboxes = list.querySelectorAll('input[type="checkbox"]')
  checkboxes.forEach((cb) => {
    cb.addEventListener('change', () => {
      const selected = Array.from(checkboxes)
        .filter((c) => c.checked && c.value !== '')
        .map((c) => c.nextElementSibling.textContent.trim())
  
      text.textContent = selected.length > 0 ? selected.join(', ') : 'Todos os departamentos'
    })
  })
  
  // Fecha ao clicar fora
  document.addEventListener('click', (e) => {
    if (!btn.contains(e.target) && !list.contains(e.target)) {
      list.classList.add('hidden')
    }
  })
</script>
<script>
  const dados = JSON.parse('{{ json_dados_percentual|escapejs }}');

  // Inicializar gr√°ficos
  const chartBarrasTop = echarts.init(document.getElementById("chart-barras-top"));
  const chartBarrasBottom = echarts.init(document.getElementById("chart-barras-bottom"));
  const chartPizza = echarts.init(document.getElementById("chart-pizza"));
  const chartDispersao = echarts.init(document.getElementById("chart-dispersao"));
  const chartComparativo = echarts.init(document.getElementById("chart-comparativo"));

  function atualizarResumo(dados) {
    const totalUsuarios = dados.length;
    const totalTarefas = dados.reduce((sum, item) => sum + item.total_tarefas, 0);
    const totalConcluidas = dados.reduce((sum, item) => sum + item.tarefas_concluidas, 0);
    const percentualMedio = totalUsuarios > 0 ? (dados.reduce((sum, item) => sum + item.percentual, 0) / totalUsuarios).toFixed(1) : 0;

    document.getElementById("total-usuarios").textContent = totalUsuarios;
    document.getElementById("total-tarefas").textContent = totalTarefas;
    document.getElementById("total-concluidas").textContent = totalConcluidas;
    document.getElementById("percentual-medio").textContent = percentualMedio + "%";
  }

  function atualizarGraficoBarrasTop(dados) {
    const top10 = [...dados].sort((a,b)=>b.percentual-a.percentual).slice(0,10);
    chartBarrasTop.setOption({
      title: { text: "Melhores Performances", textStyle: { fontSize:14, color:"#10B981" } },
      tooltip: { trigger:"axis", formatter: p => {
        const d = top10[p[0].dataIndex];
        return d.nome+"<br/>Percentual: "+d.percentual+"%<br/>Tarefas: "+d.total_tarefas+"<br/>Conclu√≠das: "+d.tarefas_concluidas;
      }},
      xAxis: { type:"category", data: top10.map(d => d.nome.length>12? d.nome.substring(0,12)+"...":d.nome), axisLabel:{rotate:45,fontSize:10} },
      yAxis: { type:"value", max:100, axisLabel:{formatter:"{value}%"} },
      series: [{ type:"bar", barWidth:"60%", data: top10.map(d=>({value:d.percentual, itemStyle:{color:new echarts.graphic.LinearGradient(0,0,0,1,[{offset:0,color:"#10B981"},{offset:1,color:"#059669"}])}})) }]
    });
  }

  function atualizarGraficoBarrasBottom(dados) {
    const bottom10 = [...dados].sort((a,b)=>a.percentual-b.percentual).slice(0,10);
    chartBarrasBottom.setOption({
      title: { text: "Precisam de Aten√ß√£o", textStyle:{ fontSize:14, color:"#EF4444" } },
      tooltip: { trigger:"axis", formatter: p => {
        const d = bottom10[p[0].dataIndex];
        return d.nome+"<br/>Percentual: "+d.percentual+"%<br/>Tarefas: "+d.total_tarefas+"<br/>Conclu√≠das: "+d.tarefas_concluidas+"<br/><strong style='color:#EF4444;'>Necessita acompanhamento!</strong>";
      }},
      xAxis: { type:"category", data: bottom10.map(d=>d.nome.length>12?d.nome.substring(0,12)+"...":d.nome), axisLabel:{rotate:45,fontSize:10} },
      yAxis: { type:"value", max:100, axisLabel:{formatter:"{value}%"} },
      series: [{ type:"bar", barWidth:"60%", data: bottom10.map(d=>({value:d.percentual, itemStyle:{color:new echarts.graphic.LinearGradient(0,0,0,1,[{offset:0,color:"#FEF2F2"},{offset:1,color:"#EF4444"}])}})) }]
    });
  }

  function atualizarGraficoPizza(dados) {
    const excelente = dados.filter(d=>d.percentual>=80).length;
    const bom = dados.filter(d=>d.percentual>=60 && d.percentual<80).length;
    const regular = dados.filter(d=>d.percentual>=40 && d.percentual<60).length;
    const baixo = dados.filter(d=>d.percentual<40).length;

    chartPizza.setOption({
      tooltip:{ trigger:"item", formatter:"{a} <br/>{b}: {c} ({d}%)" },
      legend:{ orient:"vertical", left:"left" },
      series:[{ name:"Performance", type:"pie", radius:"50%", data:[
        { value:excelente, name:"Excelente (80%+)", itemStyle:{color:"#10B981"} },
        { value:bom, name:"Bom (60-79%)", itemStyle:{color:"#F59E0B"} },
        { value:regular, name:"Regular (40-59%)", itemStyle:{color:"#F97316"} },
        { value:baixo, name:"Baixo (<40%)", itemStyle:{color:"#EF4444"} },
      ], emphasis:{itemStyle:{shadowBlur:10, shadowOffsetX:0, shadowColor:"rgba(0,0,0,0.5)"}}}]
    });
  }

  function atualizarGraficoComparativo(dados) {
    const sorted = [...dados].sort((a,b)=>b.percentual-a.percentual);
    const top5 = sorted.slice(0,5);
    const bottom5 = sorted.slice(-5).reverse();

    chartComparativo.setOption({
      tooltip:{ trigger:"axis", axisPointer:{ type:"shadow" } },
      legend:{ data:["Top 5 Melhores","Top 5 Piores"] },
      xAxis:{ type:"value", max:100, axisLabel:{formatter:"{value}%"} },
      yAxis:{ type:"category", data:["5¬∫","4¬∫","3¬∫","2¬∫","1¬∫"] },
      series:[
        { name:"Top 5 Melhores", type:"bar", data:top5.map(d=>d.percentual), itemStyle:{color:new echarts.graphic.LinearGradient(0,0,1,0,[{offset:0,color:"#10B981"},{offset:1,color:"#059669"}])} },
        { name:"Top 5 Piores", type:"bar", data:bottom5.map(d=>d.percentual), itemStyle:{color:new echarts.graphic.LinearGradient(0,0,1,0,[{offset:0,color:"#FEF2F2"},{offset:1,color:"#EF4444"}])} }
      ]
    });
  }

  function atualizarGraficoDispersao(dados) {
    chartDispersao.setOption({
      tooltip:{ trigger:"item", formatter: p=>{
        const d = dados[p.dataIndex];
        return d.nome+"<br/>Total: "+p.value[0]+" tarefas<br/>Percentual: "+p.value[1]+"%<br/>Conclu√≠das: "+d.tarefas_concluidas;
      }},
      xAxis:{ type:"value", name:"Total de Tarefas", nameLocation:"middle", nameGap:30 },
      yAxis:{ type:"value", name:"Percentual (%)", nameLocation:"middle", nameGap:40, max:100 },
      series:[{
        symbolSize: d=>Math.sqrt(d[0])*3,
        data:dados.map(d=>[d.total_tarefas,d.percentual]),
        type:"scatter",
        itemStyle:{ color: p => p.value[1]>=80?"#10B981": p.value[1]>=60?"#F59E0B":"#EF4444" }
      }]
    });
  }

  function atualizarDashboard(dados) {
    atualizarResumo(dados);
    atualizarGraficoBarrasTop(dados);
    atualizarGraficoBarrasBottom(dados);
    atualizarGraficoPizza(dados);
    atualizarGraficoComparativo(dados);
    atualizarGraficoDispersao(dados);
  }

  // Inicializa o dashboard com os dados do context
  document.addEventListener("DOMContentLoaded", ()=>{
    atualizarDashboard(dados);
    window.addEventListener("resize", ()=>atualizarDashboard(dados));
  });
</script>
{% endblock %}
