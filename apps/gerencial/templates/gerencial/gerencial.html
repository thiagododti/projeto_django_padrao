{% extends 'base.html' %}
{% load static %}
{% block content %}
  <div class="w-full flex flex-col gap-4 p-2">
    <!-- Corpo da Tela Gerencial -->
    <div class="p-6">
      <!-- Cabeçalho -->
      <div class="flex justify-between items-center mb-8">
        <div class="w-full">
          <h1 class="text-3xl font-bold text-gray-900 mb-2">Dashboard Gerencial</h1>
          <p class="text-gray-600">Acompanhe o desempenho da sua equipe</p>
        </div>

        <form method="post" action="{% url 'gerencial' %}" class="flex gap-4 items-end w-full">
          {% csrf_token %}
          <input type="hidden" name="filtro" value="true" />

          <div class="flex flex-col">
            <label for="empresa" class="text-sm font-medium text-gray-700 mb-1">Empresa</label>
            <select name="empresa" id="empresa" class="border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
              <option value="">Todas as empresas</option>
              {% for emp in empresas %}
                <option value="{{ emp.id }}">{{ emp.nome }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="relative w-full">
            <!-- Botão do select -->
            <button type="button" id="departamentoBtn" class="w-full bg-white border border-gray-300 rounded-md px-3 py-2 text-left focus:outline-none focus:ring-2 focus:ring-purple-500 flex justify-between items-center">
              <span id="departamentoText">Todos os departamentos</span>
              <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>

            <!-- Lista de checkboxes -->
            <div id="departamentoList" class="absolute z-10 mt-1 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto hidden">
              <label class="flex items-center gap-2 p-2 hover:bg-gray-100 cursor-pointer"><input type="checkbox" name="departamento" value="" class="h-4 w-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500" checked />Todos os departamentos</label>
              {% for dep in departamentos %}
                <label class="flex items-center gap-2 p-2 hover:bg-gray-100 cursor-pointer">
                  <input type="checkbox" name="departamento" value="{{ dep.id }}" class="h-4 w-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500" />
                  {{ dep.nome }}
                </label>
              {% endfor %}
            </div>
          </div>

          <button type="submit" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 transition-colors duration-200">Filtrar</button>
        </form>
      </div>

      <!-- Grid de Funcionários -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="employeeGrid">
        {% for card in cards %}
          <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow duration-200">
            <div class="flex justify-between items-top 2">
              <div class="flex items-center mb-4">
                {% if card.foto is not None %}
                  <img src="{{ card.foto }}" alt="{{ card.nome }}" class="w-12 h-12 rounded-full object-cover mr-3" />
                {% else %}
                  <div class="flex w-12 h-12 items-center justify-center rounded-full object-cover mr-3 bg-[{{ empresa.cor_background }}]">
                    <i class="material-icons text-4xl text-[{{ empresa.cor_texto }}]">person</i>
                  </div>
                {% endif %}
                <div>
                  <h3 class="font-semibold text-gray-900">{{ card.nome }}</h3>
                  <p class="text-sm text-gray-600">{{ card.cargo }}</p>
                </div>
              </div>
              <button onclick="window.location.href='{% url 'dados_funcionario' card.id_func %}'" class="border-2 border-purple-600 text-purple-600 hover:bg-purple-600 hover:text-white w-10 h-10 rounded-lg transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 flex items-center justify-center">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
              </button>
            </div>

            <div class="mb-4">
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">{{ card.departamento }}</span>
            </div>

            <div class="mb-4">
              <div class="flex justify-between items-center mb-1">
                <span class="text-sm font-medium text-gray-700">Eficácia</span>
                <span class="text-sm font-semibold efetividade-text" data-value="{{ card.efetividade }}">{{ card.efetividade }}%</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="h-2 rounded-full efetividade-bar" data-width="{{ card.efetividade }}"></div>
              </div>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-4">
              <div class="text-center">
                <div class="text-lg font-bold text-gray-900">{{ card.tarefas_abertas }}</div>
                <div class="text-xs text-gray-500">Tarefas Abertas</div>
              </div>
              <div class="text-center">
                <div class="text-lg font-bold text-gray-900">{{ card.total_tarefas }}</div>
                <div class="text-xs text-gray-500">Total Tarefas</div>
              </div>
            </div>

            <div class="flex justify-around items-center gap-8 pt-4 border-t border-gray-100">
              <div class="text-center">
                <div class="text-lg font-bold text-orange-600">{{ card.reunioes_abertas }}</div>
                <div class="text-xs text-gray-500">Reuniões Abertas</div>
              </div>

              <div class="text-center">
                <!-- Texto do status com cores -->

                {% if card.checkin_status == 'aberto' %}
                  <div class="text-lg font-bold text-yellow-600">Aberto</div>
                {% elif card.checkin_status == 'fechado' %}
                  <div class="text-lg font-bold text-green-600">Fechado</div>
                {% else %}
                  <div class="text-lg font-bold text-gray-400">Não Aberto</div>
                {% endif %}

                <div class="text-xs text-gray-500">Checkin Hoje</div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

      <!-- Paginação -->
      {% comment %} <div class="flex items-center justify-between mt-8">
        <div class="text-sm text-gray-700">
          Mostrando <span class="font-medium">1</span> a <span class="font-medium">6</span> de <span class="font-medium">24</span> funcionários
        </div>
        <div class="flex space-x-2">
          <button class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">Anterior</button>
          <button class="px-3 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700">1</button>
          <button class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">2</button>
          <button class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">3</button>
          <button class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">Próximo</button>
        </div>
      </div> {% endcomment %}
    </div>
  </div>
  {% include 'tarefas/partials/modais.html' %}
  <script src="{% static 'js/barra_efetividade_gerencial.js' %}"></script>
  <script>
    const btn = document.getElementById('departamentoBtn')
    const list = document.getElementById('departamentoList')
    const text = document.getElementById('departamentoText')
    
    btn.addEventListener('click', () => {
      list.classList.toggle('hidden')
    })
    
    // Atualiza o texto do botão com os selecionados
    const checkboxes = list.querySelectorAll('input[type="checkbox"]')
    checkboxes.forEach((cb) => {
      cb.addEventListener('change', () => {
        const selected = Array.from(checkboxes)
          .filter((c) => c.checked && c.value !== '')
          .map((c) => c.nextElementSibling.textContent.trim())
    
        text.textContent = selected.length > 0 ? selected.join(', ') : 'Todos os departamentos'
      })
    })
    
    // Fecha ao clicar fora
    document.addEventListener('click', (e) => {
      if (!btn.contains(e.target) && !list.contains(e.target)) {
        list.classList.add('hidden')
      }
    })
  </script>
{% endblock %}
