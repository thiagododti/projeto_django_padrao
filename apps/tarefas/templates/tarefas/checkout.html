{% extends 'base.html' %}
{% load static %}
{% block head %}
  <style>
    .line-clamp-3 {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .progress-bar {
            animation: progressAnimation 2s ease-out forwards;
          }

          @keyframes progressAnimation {
            from {
              width: 0%;
            }
            to {
              width: var(--progress-width);
            }
          }
  </style>
{% endblock %}
{% block content %}
  <div class="w-full mx-auto px-2 py-2">
    <!-- Header -->
    <div class="flex justify-between items-center mb-8">
      <h1 class="text-3xl font-bold text-gray-800">Acompanhamento de Check-in</h1>
      <div class="flex gap-3">
        <button onclick="location.href='{% url 'criar_tarefa_checkout' %}'" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition-colors">+ Adicionar Tarefa</button>
        <button onclick="abrirModal('realizarcheckoutModal')" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium transition-colors">Realizar Check-out</button>
      </div>
    </div>
    <!-- Indicadores e Progresso -->
    <div class="bg-white rounded-lg shadow-sm border mb-8">
      <!-- Indicadores -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 p-4 border-b">
        <div class="text-center">
          <h3 class="text-xs font-medium text-gray-500 mb-1">Taxa de Resolu√ß√£o</h3>
          <p class="text-2xl font-bold text-gray-800" id="taxaResolucao">{{ taxa_resolucao|floatformat:2 }}%</p>
        </div>
        <div class="text-center">
          <h3 class="text-xs font-medium text-gray-500 mb-1">Tarefas Conclu√≠das</h3>
          <p class="text-2xl font-bold text-green-600" id="tarefasConcluidas">{{ tarefas_concluidas }}</p>
        </div>
        <div class="text-center">
          <h3 class="text-xs font-medium text-gray-500 mb-1">Tarefas N√£o Planejadas</h3>
          <p class="text-2xl font-bold text-orange-600" id="tarefasNaoPlanejadas">{{ tarefas_nao_planejadas_count }}</p>
        </div>
        <div class="text-center">
          <h3 class="text-xs font-medium text-gray-500 mb-1">Reuni√µes</h3>
          <p class="text-2xl font-bold text-blue-600" id="reunioes">{{ reunioes }}</p>
        </div>
      </div>

      <!-- Barra de Progresso -->
      <div class="bg-gray-50 p-4 rounded-lg">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-lg font-semibold text-gray-800">Progresso de Tarefas Conclu√≠das</h3>
          <span class="text-sm font-medium text-gray-600">{{ taxa_resolucao|floatformat:0 }}%</span>
        </div>

        <div class="w-full bg-gray-200 rounded-full h-2">
          <div class="bg-gradient-to-r from-green-400 to-green-600 h-2 rounded-full shadow-sm progress-bar" style="--progress-width: {{ taxa_resolucao|floatformat:0 }}%; width: 0%"></div>
        </div>
        <div class="flex justify-between text-xs text-gray-500 mt-1">
          <span>0%</span>
          <span>{{ tarefas_concluidas }} de {{ total_tarefas }} tarefas conclu√≠das</span>
          <span>100%</span>
        </div>
      </div>
    </div>

    <!-- Painel de Tarefas -->
    <div class="bg-white rounded-lg shadow-sm border">
      <div class="p-6 border-b flex justify-between items-center">
        <h2 class="text-xl font-semibold text-gray-800">Painel de Tarefas</h2>
        <div class="flex items-center gap-4">
          <span class="text-sm text-gray-600" id="infoTarefas">Mostrando {{ page_obj.start_index }}-{{ page_obj.end_index }} de {{ total_tarefas }} tarefas</span>
          <select id="itensPorPagina" onchange="alterarItensPorPagina()" class="border border-gray-300 rounded px-2 py-1 text-sm">
            <option value="6" {% if request.GET.per_page == '6' %}selected{% endif %}>6 por p√°gina</option>
            <option value="9" {% if request.GET.per_page == '9' %}selected{% endif %}>9 por p√°gina</option>
            <option value="12" {% if request.GET.per_page == '12' %}selected{% endif %}>12 por p√°gina</option>
            <option value="15" {% if request.GET.per_page == '15' %}selected{% endif %}>15 por p√°gina</option>
          </select>
        </div>
      </div>

      <div class="p-6">
        <div class="grid grid-cols-1 xl:grid-cols-2 2xl:grid-cols-3 gap-6" id="painelTarefas">
          {% for tarefa in object_list %}
            <!-- Card de Tarefa -->

            {% if tarefa.concluida %}
              <div class="bg-slate-50 border rounded-lg p-4 border-green-400 hover:shadow-md transition-shadow flex flex-col justify-between">
            {% else %}
              <div class="bg-slate-50 border rounded-lg p-4 border-red-200 hover:shadow-md transition-shadow flex flex-col justify-between">
            {% endif %}
              <!-- Cabe√ßalho -->
              <div class="flex justify-between items-start mb-3 gap-2">
                <h3 class="font-semibold text-gray-800 text-lg">{{ tarefa.titulo }}</h3>
                <!-- Exibe apenas se tiver diretoria -->
                <div class="flex flex-col gap-2">
                  {% if tarefa.concluida %}
                  <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full font-medium">CONCLU√çDA</span>
                {% else %}
                  <span class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded-full font-medium">PENDENTE</span>
                {% endif %}
                {% if tarefa.solicitacao_diretoria %}
                  <span class="bg-indigo-100 text-indigo-800 text-xs px-2 py-1 rounded-full font-medium">DIRETORIA</span>
                {% endif %}
                </div>
              </div>

              <!-- Descri√ß√£o -->
              <div class="mb-4 border-b border-gray-200">
                <p id="desc-{{ tarefa.id }}" class="text-gray-600 text-sm leading-relaxed line-clamp-3">{{ tarefa.descricao }}</p>
                {% if tarefa.descricao|length > 200 %}
                <button onclick="toggleDescricao({{ tarefa.id }})" class="text-blue-600 hover:text-blue-800 text-xs mt-1 font-medium">Ver mais</button>
                {% endif %}
              </div>

              <!-- Observa√ß√µes (opcional) -->
              {% if tarefa.observacoes %}
                <div class="mb-4 p-3 bg-yellow-50 border-l-4 border-yellow-400 rounded-r ">
                  <h4 class="text-xs font-semibold text-yellow-800 mb-1">üìù Observa√ß√µes</h4>
                  <p id="obs-{{ tarefa.id }}" class="text-yellow-700 whi text-sm leading-relaxed line-clamp-3">{{ tarefa.observacoes }}</p>
                  {% if tarefa.observacoes|length > 200 %}
                  <button onclick="toggleObservacoes({{ tarefa.id }})" class="text-yellow-600 hover:text-yellow-800 text-xs mt-1 font-medium">Ver mais</button>
                  {% endif %}
                </div>
              {% endif %}

              <!-- Informa√ß√µes adicionais -->
              <div class="space-y-2 mb-4">
                <div class="flex justify-between text-sm">
                  <span class="text-gray-500">Horas:</span>
                  <span class="text-gray-800">{{ tarefa.horas_estimadas }} estimadas</span>
                </div>
                {% if tarefa.cliente_tarefa %}
                <div class="flex justify-between text-sm">
                  <span class="text-gray-500">Cliente:</span>
                  <span class="text-gray-800">{{ tarefa.cliente_tarefa }}</span>
                </div>
                {% endif %}
                <div class="flex justify-between text-sm">
                  <span class="text-gray-500">Origem ‚Üí Destino:</span>
                  <span class="text-gray-800">{{ tarefa.origem_tarefa }} ‚Üí {{ tarefa.destino_tarefa }}</span>
                </div>
                <div class="flex justify-between text-sm">
                  <span class="text-gray-500">Abertura:</span>
                  {% if tarefa.data_inicio_real %}
                    <span class="text-gray-800">{{ tarefa.data_inicio_real|date:'d/m/Y H:i' }}</span>
                  {% else %}
                    <span class="text-gray-800">{{ tarefa.data_criacao|date:'d/m/Y H:i' }}</span>
                  {% endif %}
                </div>
                {% if tarefa.data_conclusao_real %}
                <div class="flex justify-between text-sm">
                  <span class="text-gray-500">Conclus√£o:</span>
                    <span class="text-gray-800">{{ tarefa.data_conclusao_real|date:'d/m/Y H:i' }}</span>
                </div>
                {% endif %}
                  
              </div>

              <!-- Tags -->
              <div class="flex justify-between items-center mb-3">
                <div class="flex gap-2">
                  {% if tarefa.prioridade == 'Alta' %}
                    <span class="px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">Alta</span>
                  {% elif tarefa.prioridade == 'M√©dia' %}
                    <span class="px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">M√©dia</span>
                  {% elif tarefa.prioridade == 'Baixa' %}
                    <span class="px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">Baixa</span>
                  {% endif %}
                  {% if tarefa.tipo == 'planejada' %}
                    <span class="px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">Planejada</span>
                  {% elif tarefa.tipo == 'nao_planejada' %}
                    <span class="px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">N√£o Planejada</span>
                  {% elif tarefa.tipo == 'reuniao' %}
                    <span class="px-2 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800">Reuni√£o</span>
                  {% endif %}
                </div>
              </div>

              <!-- Bot√µes -->
              <div class="flex gap-2 pt-3 border-t border-gray-200">
                {% if tarefa.concluida %}
                  <button onclick="location.href='{% url 'remover_conclusao_tarefa_checkin' tarefa.id %}'" class="flex-1 px-3 py-2 rounded text-sm font-medium transition-colors bg-yellow-100 text-yellow-800 hover:bg-yellow-200">Reabrir Tarefa</button>
                  {% if not tarefa.tipo == 'planejada' %}
                    <button onclick="abrirModal('deletartarefaModal', {{ tarefa.id }}, '{% url 'deletar_tarefa_checkin' tarefa.id %}')" class="px-3 py-2 rounded text-sm font-medium bg-red-100 text-red-800 hover:bg-red-200 transition-colors">üóëÔ∏è Deletar</button>
                  {% endif %}
                {% else %}
                  <button onclick="location.href='{% url 'concluir_tarefa_checkout' tarefa.id %}'" class="flex-1 px-3 py-2 rounded text-sm font-medium transition-colors bg-green-100 text-green-800 hover:bg-green-200">Concluir</button>
                  <button onclick="location.href='{% url 'editar_tarefa_checkout' tarefa.id %}'" class="px-3 py-2 rounded text-sm font-medium bg-blue-100 text-blue-800 hover:bg-blue-200 transition-colors">‚úèÔ∏è Editar</button>
                  {% if not tarefa.tipo == 'planejada' %}
                    <button onclick="abrirModal('deletartarefaModal', {{ tarefa.id }}, '{% url 'deletar_tarefa_checkin' tarefa.id %}')" class="px-3 py-2 rounded text-sm font-medium bg-red-100 text-red-800 hover:bg-red-200 transition-colors">üóëÔ∏è Deletar</button>
                  {% endif %}
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>

        <!-- Pagina√ß√£o -->
        <div class="flex justify-between items-center mt-8 pt-6 border-t border-gray-200">
          {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}" class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">‚Üê Anterior</a>
          {% else %}
            <button disabled class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-lg opacity-50 cursor-not-allowed">‚Üê Anterior</button>
          {% endif %}

          <div class="flex gap-1">
            {% for num in page_obj.paginator.page_range %}
              {% if page_obj.number == num %}
                <span class="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-blue-600 rounded-lg">{{ num }}</span>
              {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <a href="?page={{ num }}" class="px-4 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">{{ num }}</a>
              {% endif %}
            {% endfor %}
          </div>

          {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}" class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">Pr√≥ximo ‚Üí</a>
          {% else %}
            <button disabled class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-lg opacity-50 cursor-not-allowed">Pr√≥ximo ‚Üí</button>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  {% include 'tarefas/partials/modais.html' %}
  <script>
    function toggleDescricao(id) {
      const descElement = document.getElementById(`desc-${id}`)
      const button = descElement.nextElementSibling
    
      if (descElement.classList.contains('line-clamp-3')) {
        descElement.classList.remove('line-clamp-3')
        button.textContent = 'Ver menos'
      } else {
        descElement.classList.add('line-clamp-3')
        button.textContent = 'Ver mais'
      }
    }
    
    function toggleObservacoes(id) {
      const obsElement = document.getElementById(`obs-${id}`)
      const button = obsElement.nextElementSibling
    
      if (obsElement.classList.contains('line-clamp-3')) {
        obsElement.classList.remove('line-clamp-3')
        button.textContent = 'Ver menos'
      } else {
        obsElement.classList.add('line-clamp-3')
        button.textContent = 'Ver mais'
      }
    }
    function alterarItensPorPagina() {
      const select = document.getElementById("itensPorPagina");
      const itens = select.value;
      const params = new URLSearchParams(window.location.search);

      // Atualiza (ou cria) o par√¢metro
      params.set("per_page", itens);
      params.set("page", 1); // sempre volta pra p√°gina 1

      // Redireciona para a URL com os par√¢metros
      window.location.search = params.toString();
    }
  </script>
{% endblock %}